<script defer>

  var botones = document.querySelectorAll('.btn-main');
  var droplistClientes = document.querySelectorAll('.cliente-array');
  var droplistEmpleados = document.querySelectorAll('.empleado-array');
  var droplistVendedores = document.querySelectorAll('.vendedor-array');
  var droplistEventos = document.querySelectorAll('.evento-array');
  var droplistProgramas = document.querySelectorAll('.programa-array');
  var sectionsTables = document.querySelectorAll('.sections-tables');
  sectionsTables.forEach(function(element) {
    element.style.display = 'none';
  });

  // Obtener elementos globales, fuera de la función
  let barraDeTiempo = document.getElementById('calificacionCliente');
  let cajaNumeral = document.getElementById('numberCalificacionCliente');
  // Asignar evento a barra
  barraDeTiempo.addEventListener('input', mostrar);
  // Función para actualizar
  function mostrar() {
      // Asignar a caja el valor de la barra
      cajaNumeral.innerHTML = barraDeTiempo.value;
  }

  // Iterar sobre cada botón para agregar un evento de clic
  botones.forEach(function(boton) {
    boton.addEventListener('click', function(event) {
      sectionsTables.forEach(function(element) {
        element.style.display = 'none';
      });
      var buttonId = event.target.id;
      var nombreSeccion = buttonId.replace('Btn', '');
      nombreSeccion = nombreSeccion+'-section';
      var seccion = document.getElementById(nombreSeccion);
      if (seccion.style.display === 'none') {
        seccion.style.display = 'block'; // Muestra la sección
      } else {
        seccion.style.display = 'none'; // Oculta la sección
      }
    });
  });

  function loadingOnOff(btnNameGuardar,btnNameLoading){
    console.log('IMPRESION NOMBRES DE LOS BOTONES');
    console.log(btnNameGuardar);
    console.log(btnNameLoading);
    var btnGuardar = document.getElementById(btnNameGuardar);
    var btnLoading = document.getElementById(btnNameLoading);
    if (btnGuardar.classList.contains("d-none")) {
      btnGuardar.classList.remove("d-none");
      btnLoading.classList.add("d-none");
    } else {
      btnGuardar.classList.add("d-none");
      btnLoading.classList.remove("d-none");
    }
  }


  let objectInfo = {};
  window.addEventListener('load' , () => {
    google.script.run
    .withSuccessHandler(object => {
      objectInfo = object;
      loadTable(objectInfo);
    })
    .getData();
  } );

  function loadTable ( object ){

    var arreglosClientes = object['cliente']['usersInfo_cliente'];
    var arreglosVendedores = object['vendedor']['usersInfo_vendedor'];
    var arreglosEmpleados = object['empleado']['usersInfo_empleado'];
    var arreglosEventos = object['evento']['usersInfo_evento'];
    var arreglosProgramas = object['programa']['usersInfo_programa'];
    var option_select_clientes = "";
    var option_select_vendedores = "";
    var option_select_empleados = "";
    var option_select_eventos = "";
    var option_select_programas = "";

    // Iterar sobre cada array y obtener el valor en la posición 6
    arreglosClientes.forEach(array => {
      if (array.length >= 13) { 
          option_select_clientes = option_select_clientes + '<option value="'+array[13]+'">' + array[13] + '</option>';
      }
    });

    option_select_clientes = option_select_clientes + '<option value="0-NO APLICA"> 0-NO APLICA </option>';

    arreglosVendedores.forEach(array => {
      if (array.length >= 14) { 
          option_select_vendedores = option_select_vendedores + '<option value="'+array[14]+'">' + array[14] + '</option>';
      }
    });

    arreglosEmpleados.forEach(array => {
      if (array.length >= 12) { 
          option_select_empleados = option_select_empleados + '<option value="'+array[12]+'">' + array[12] + '</option>';
      }
    });

    arreglosEventos.forEach(array => {
      if (array.length >= 17) { 
          option_select_eventos = option_select_eventos + '<option value="'+array[17]+'">' + array[17] + '</option>';
      }
    });

    arreglosProgramas.forEach(array => {
      if (array.length >= 18) { 
          option_select_programas = option_select_programas + '<option value="'+array[18]+'">' + array[18] + '</option>';
      }
    });

    option_select_programas = option_select_programas + '<option value="0-NO APLICA"> 0-NO APLICA </option>';

    droplistVendedores.forEach(function(select) {
      select.innerHTML = option_select_vendedores;
    });
    droplistEmpleados.forEach(function(select) {
      select.innerHTML = option_select_empleados;
    });
    droplistClientes.forEach(function(select) {
      select.innerHTML = option_select_clientes;
    });
    droplistEventos.forEach(function(select) {
      select.innerHTML = option_select_eventos;
    });
    droplistProgramas.forEach(function(select) {
      select.innerHTML = option_select_programas;
    });

    function capitalizeFirstLetter(string) {
        string = string.replaceAll("_", ' ');
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    for (const key in object) {
      const value = object[key];
      const headers = value['headers_'+key];
      const usersInfo = value['usersInfo_'+key];
      const tableName = '#tabla-'+key;

      const formattedCols = headers.map( header => {
          header = capitalizeFirstLetter(header);
          return {'title':header}
        });
      formattedCols.push({ 'title': 'Acciones' });
      // Modificar la data para incluir el código HTML en la columna "Acciones"
      const newData = usersInfo.map(row => {
        // Aquí debes modificar 'row' según la estructura de tu objeto 'usersInfo'
        const actionsHTML = '<i class="bi bi-pencil-square button-edit me-3" role="button" onclick="editarRegistroModal(this,nombreTabla=\''+key+'\')"></i>';
        row.push(actionsHTML); // Agregar el código HTML a la fila
        return row;
      });

      switch (key) {
          case 'empleado':
            var miTable = new DataTable(tableName,{
              columns: formattedCols,
              data: newData,
              language: {
                  lengthMenu: 'Mostrar _MENU_ registros por página',
                  zeroRecords: 'Ningún registro encontrado',
                  info: 'Monstrando de _START_ a _END_ de un total de _TOTAL_ registros',
                  infoEmpty: 'Ningún registro econtrado',
                  infofFiltered: '(filtrados desde _MAX_ registros totales)',
                  search: 'Buscar:',
                  loadingRecords: 'Cargando...'
              }
            });
            miTable.column(12).visible(false);
            break;
          case 'vendedor':
            var miTable = new DataTable(tableName,{
              columns: formattedCols,
              data: newData,
              language: {
                  lengthMenu: 'Mostrar _MENU_ registros por página',
                  zeroRecords: 'Ningún registro encontrado',
                  info: 'Monstrando de _START_ a _END_ de un total de _TOTAL_ registros',
                  infoEmpty: 'Ningún registro econtrado',
                  infofFiltered: '(filtrados desde _MAX_ registros totales)',
                  search: 'Buscar:',
                  loadingRecords: 'Cargando...'
              }
            });
            miTable.column(14).visible(false);
            break;
          case 'cliente':
            var miTable = new DataTable(tableName,{
              columns: formattedCols,
              data: newData,
              language: {
                  lengthMenu: 'Mostrar _MENU_ registros por página',
                  zeroRecords: 'Ningún registro encontrado',
                  info: 'Monstrando de _START_ a _END_ de un total de _TOTAL_ registros',
                  infoEmpty: 'Ningún registro econtrado',
                  infofFiltered: '(filtrados desde _MAX_ registros totales)',
                  search: 'Buscar:',
                  loadingRecords: 'Cargando...'
              }
            });
            miTable.column(2).visible(false);
            miTable.column(3).visible(false);
            miTable.column(4).visible(false);
            miTable.column(13).visible(false);

            break;
          case 'evento':
            var miTable = new DataTable(tableName,{
              columns: formattedCols,
              data: newData,
              language: {
                  lengthMenu: 'Mostrar _MENU_ registros por página',
                  zeroRecords: 'Ningún registro encontrado',
                  info: 'Monstrando de _START_ a _END_ de un total de _TOTAL_ registros',
                  infoEmpty: 'Ningún registro econtrado',
                  infofFiltered: '(filtrados desde _MAX_ registros totales)',
                  search: 'Buscar:',
                  loadingRecords: 'Cargando...'
              }
            });
            miTable.column(1).visible(false);
            miTable.column(2).visible(false);
            miTable.column(3).visible(false);
            miTable.column(17).visible(false);
            miTable.column(18).visible(false);
            break;
          case 'programa':
            var miTable = new DataTable(tableName,{
              columns: formattedCols,
              data: newData,
              language: {
                  lengthMenu: 'Mostrar _MENU_ registros por página',
                  zeroRecords: 'Ningún registro encontrado',
                  info: 'Monstrando de _START_ a _END_ de un total de _TOTAL_ registros',
                  infoEmpty: 'Ningún registro econtrado',
                  infofFiltered: '(filtrados desde _MAX_ registros totales)',
                  search: 'Buscar:',
                  loadingRecords: 'Cargando...'
              }
            });
            miTable.column(18).visible(false);
            miTable.column(19).visible(false);
            break;
          case 'venta':
            var miTable = new DataTable(tableName,{
              columns: formattedCols,
              data: newData,
              language: {
                  lengthMenu: 'Mostrar _MENU_ registros por página',
                  zeroRecords: 'Ningún registro encontrado',
                  info: 'Monstrando de _START_ a _END_ de un total de _TOTAL_ registros',
                  infoEmpty: 'Ningún registro econtrado',
                  infofFiltered: '(filtrados desde _MAX_ registros totales)',
                  search: 'Buscar:',
                  loadingRecords: 'Cargando...'
              }
            });
            miTable.column(6).visible(false);
            miTable.column(7).visible(false);
            break;
          default:
            console.log('Caso no tenido en cuenta');
            break;
      }
    }
  }
  

  // Función para enviar el formulario de empleado
  function enviarFormEmpleado() {
    loadingOnOff('btnGuardarEmpleado','btnLoadingEmpleado');
    const form = document.getElementById('id-form-crear-empleado');
    const idEmpleado = form.idEmpleado.value;
    if(idEmpleado === '0'){
      console.log("Va a ejecutar la funcion crear empleado");
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarEmpleado','btnLoadingEmpleado');
        form.reset();
      })
      .createEmpleado(form);
    }
    else
    {
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarEmpleado','btnLoadingEmpleado');
        form.reset();
      })
      .modifyEmpleado(form);
    }
    
  }

  // Función para enviar el formulario de vendedor
  function enviarFormVendedor() {
    loadingOnOff('btnGuardarVendedor','btnLoadingVendedor');
    const form = document.getElementById('id-form-crear-vendedor');
    const idVendedor = form.idVendedor.value;
    if(idVendedor === '0'){
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarVendedor','btnLoadingVendedor');
        form.reset();
      })
      .createVendedor(form);
    }
    else
    {
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarVendedor','btnLoadingVendedor');
        form.reset();
      })
      .modifyVendedor(form);
    }
  }

  // Función para enviar el formulario de cliente
  function enviarFormCliente() {
    loadingOnOff('btnGuardarCliente','btnLoadingCliente');
    const form = document.getElementById('id-form-crear-cliente');
    const idCliente = form.idCliente.value;
    if(idCliente === '0'){
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarCliente','btnLoadingCliente');
        form.reset();
      })
      .createCliente(form);
    }
    else
    {
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarCliente','btnLoadingCliente');
        form.reset();
      })
      .modifyCliente(form);
    }
  }

  // Función para enviar el formulario de programa
  function enviarFormPrograma() {
    loadingOnOff('btnGuardarPrograma','btnLoadingPrograma');
    const form = document.getElementById('id-form-crear-programa');
    const idPrograma = form.idPrograma.value;
    if(idPrograma === '0'){
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarPrograma','btnLoadingPrograma');
        form.reset();
      })
      .createPrograma(form);
    }
    else
    {
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarPrograma','btnLoadingPrograma');
        form.reset();
      })
      .modifyPrograma(form);
    }
  }

  // Función para enviar el formulario de Evento
  function enviarFormEvento() {
    loadingOnOff('btnGuardarEvento','btnLoadingEvento');
    const form = document.getElementById('id-form-crear-evento');
    const idEvento = form.idEvento.value;
    if(idEvento === '0'){
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarEvento','btnLoadingEvento');
        form.reset();
      })
      .createEvento(form);
    }
    else
    {
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarEvento','btnLoadingEvento');
        form.reset();
      })
      .modifyEvento(form);
    }
  }

  // Función para enviar el formulario de venta
  function enviarFormVenta() {
    loadingOnOff('btnGuardarVenta','btnLoadingVenta');
    const form = document.getElementById('id-form-crear-venta');
    const idVenta = form.idVenta.value;
    if(idVenta === '0'){
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarVenta','btnLoadingVenta');
        form.reset();
      })
      .createVenta(form);
    }
    else
    {
      google.script.run
      .withSuccessHandler(result => {
        loadingOnOff('btnGuardarVenta','btnLoadingVenta');
        form.reset();
      })
      .modifyVenta(form);
    }
  }

  
  // Editar registros
  function editarRegistroModal(button, nombreTabla){

    const tableRow = button.parentNode.parentNode;
    var id = tableRow.cells[0].innerHTML;
    var dataRow;
    console.log("NOMBRE DE LA TABLA");
    console.log(nombreTabla);

    google.script.run
    .withSuccessHandler(object => {
      console.log("ACA EL RESULTADO DE LA FUNCION GETDATAROW");
      console.log(object);
      
      dataRow = object;
      console.log(dataRow);
      console.log(dataRow[0][6]);
      var createModal;
    
      switch (nombreTabla) {
        case 'empleado':
          createModal = bootstrap.Modal.getOrCreateInstance('#createModalEmpleado');
          createModal.show();

          document.getElementById("idEmpleado").value = tableRow.cells[0].innerHTML;
          document.getElementById("idPersonaEmpleado").value = tableRow.cells[1].innerHTML;
          document.getElementById("nombreEmpleado").value =  tableRow.cells[2].innerHTML;
          document.getElementById("apellidoEmpleado").value =  tableRow.cells[3].innerHTML;
          document.getElementById("celularEmpleado").value = tableRow.cells[4].innerHTML;
          document.getElementById("departamentoEmpleado").value = tableRow.cells[5].innerHTML;
          document.getElementById("ciudadEmpleado").value = tableRow.cells[6].innerHTML;
          document.getElementById("direccionEmpleado").value = tableRow.cells[7].innerHTML;
          document.getElementById("emailEmpleado").value = tableRow.cells[8].innerHTML;
          document.getElementById("salarioEmpleado").value = tableRow.cells[9].innerHTML;
          document.getElementById("epsEmpleado").value = tableRow.cells[10].innerHTML;
          document.getElementById("cargoEmpleado").value = tableRow.cells[11].innerHTML;

          break;
        case 'vendedor':
          createModal = bootstrap.Modal.getOrCreateInstance('#createModalVendedor');
          createModal.show();

          document.getElementById("idVendedor").value = tableRow.cells[0].innerHTML;
          document.getElementById("idPersonaVendedor").value = tableRow.cells[1].innerHTML;
          document.getElementById("nombreVendedor").value =  tableRow.cells[2].innerHTML;
          document.getElementById("apellidoVendedor").value =  tableRow.cells[3].innerHTML;
          document.getElementById("celularVendedor").value = tableRow.cells[4].innerHTML;
          document.getElementById("departamentoVendedor").value = tableRow.cells[5].innerHTML;
          document.getElementById("ciudadVendedor").value = tableRow.cells[6].innerHTML;
          document.getElementById("direccionVendedor").value = tableRow.cells[7].innerHTML;
          document.getElementById("emailVendedor").value = tableRow.cells[8].innerHTML;
          document.getElementById("epsVendedor").value = tableRow.cells[9].innerHTML;
          document.getElementById("cargoVendedor").value = tableRow.cells[10].innerHTML;
          document.getElementById("metaVendedor").value = tableRow.cells[11].innerHTML;
          document.getElementById("historicoVendedor").value = tableRow.cells[12].innerHTML;
          document.getElementById("qtyVentasVendedor").value = tableRow.cells[13].innerHTML;
          break;
        case 'cliente':
          createModal = bootstrap.Modal.getOrCreateInstance('#createModalCliente');
          createModal.show();

          document.getElementById("idCliente").value = tableRow.cells[0].innerHTML;
          document.getElementById("idPersonaCliente").value = tableRow.cells[1].innerHTML;
          document.getElementById("nombreCliente").value =  tableRow.cells[2].innerHTML;
          document.getElementById("apellidoCliente").value =  tableRow.cells[3].innerHTML;
          document.getElementById("celularCliente").value = tableRow.cells[4].innerHTML;
          document.getElementById("departamentoCliente").value = tableRow.cells[5].innerHTML;
          document.getElementById("ciudadCliente").value = tableRow.cells[6].innerHTML;
          document.getElementById("direccionCliente").value = tableRow.cells[7].innerHTML;
          document.getElementById("emailCliente").value = tableRow.cells[8].innerHTML;
          document.getElementById("calificacionCliente").value = tableRow.cells[9].innerHTML;
          document.getElementById("vendedorCliente").value = tableRow.cells[10].innerHTML;
          document.getElementById("empleadoCliente").value = tableRow.cells[11].innerHTML;
          document.getElementById("contacto_referenteCliente").value = tableRow.cells[12].innerHTML;
          break;
        case 'evento':

          createModal = bootstrap.Modal.getOrCreateInstance('#createModalEvento');
          createModal.show();

          horaInicioEvento = tableRow.cells[5].innerHTML;
          horaFinEvento = tableRow.cells[6].innerHTML;

          if(horaInicioEvento.length === 4){
            horaInicioEvento = '0'+horaInicioEvento;
          }
          if(horaFinEvento.length === 4){
            horaFinEvento = '0'+horaFinEvento;
          }

          document.getElementById("idEvento").value = tableRow.cells[0].innerHTML;
          document.getElementById("tipoEvento").value = tableRow.cells[2].innerHTML;
          document.getElementById("estadoEvento").value = tableRow.cells[3].innerHTML;
          document.getElementById("fechaEvento").value =  tableRow.cells[4].innerHTML;
          document.getElementById("horaInicioEvento").value =  horaInicioEvento;
          document.getElementById("horaFinEvento").value = horaFinEvento;
          document.getElementById("correosEvento").value =  tableRow.cells[9].innerHTML;
          document.getElementById("observacionesEvento").value = tableRow.cells[10].innerHTML;
          document.getElementById("vendedorEvento").value = tableRow.cells[11].innerHTML;
          document.getElementById("empleadoEvento").value = tableRow.cells[12].innerHTML;
          document.getElementById("clienteEvento").value = tableRow.cells[13].innerHTML;
          break;
        case 'programa':
          createModal = bootstrap.Modal.getOrCreateInstance('#createModalPrograma');
          createModal.show();

          document.getElementById("idPrograma").value = tableRow.cells[0].innerHTML;
          document.getElementById("idEventoPrograma").value = tableRow.cells[1].innerHTML;
          document.getElementById("nombrePrograma").value = tableRow.cells[2].innerHTML;
          document.getElementById("correosPrograma").value =  tableRow.cells[10].innerHTML;
          document.getElementById("diasPrograma").value = tableRow.cells[11].innerHTML;
          document.getElementById("premioPrograma").value = tableRow.cells[13].innerHTML;
          document.getElementById("resultadoPrograma").value = tableRow.cells[15].innerHTML;
          document.getElementById("eventoPrograma").value = tableRow.cells[16].innerHTML;
          break;
        case 'venta':
          createModal = bootstrap.Modal.getOrCreateInstance('#createModalVenta');
          createModal.show();

          document.getElementById("idVenta").value = tableRow.cells[0].innerHTML;
          document.getElementById("idEventoVenta").value = tableRow.cells[1].innerHTML;
          document.getElementById("articuloVenta").value =  tableRow.cells[2].innerHTML;
          document.getElementById("valorVenta").value =  tableRow.cells[3].innerHTML;
          document.getElementById("modoPagoVenta").value = tableRow.cells[4].innerHTML;
          document.getElementById("eventoVenta").value = tableRow.cells[5].innerHTML;
          break;
        default:
          console.log('Caso no tenido en cuenta');
          break;
      }    
    })
    .getDataRow(id, nombreTabla);
    
  }

</script>
